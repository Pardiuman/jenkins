pipeline{
    agent none
    // parameters{
    //     string(name: 'DOCKER', defaultValue: 'JAVA-PROGRAM', description: '')
    // }
    environment{
        DOCKER_CREDS = credentials('docker-cred')
        BUILD = "$env.BUILD_NUMBER"
        
    }
    stages{
        stage('project build'){
            agent{
                docker{
                    image 'maven'
                    args '--user root'
                }
            }
            steps{
                dir('cicd-project'){
                    sh 'mvn clean install'
                }
                
            }

        }
        stage('send dockerfile to ansible server'){

            agent any

            // environment{
            //     DOCKERFILE_NAME = "$params.DOCKER"
            // }
            
            steps{
                sshagent(['ssh-ansible']) {
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44'
                    sh 'scp -r /var/lib/jenkins/workspace/project/cicd-project/* ubuntu@34.204.5.44:/home/ubuntu/'
                    // sh 'rsync --checksum -ru /var/lib/jenkins/workspace/project/cicd-project/ ubuntu@3.95.19.37:/home/ubuntu/'
                    // sh 'ssh -o StrictHostKeyChecking=no ubuntu@3.95.19.37 cd /home/ubuntu/app/'
                    // sh 'ssh -o StrictHostKeyChecking=no ubuntu@3.95.19.37 docker build -f /home/ubuntu/app/ -t $DOCKER_CREDS_USR/javafile:1 '
                }
            }
        }

        stage('build dockerfile and push'){
            agent any
            steps{
                sshagent(['ssh-ansible']){
                    sh '''
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 cd /home/ubuntu/
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker build -t javafile:$BUILD_NUMBER .
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker tag javafile:$BUILD_NUMBER $DOCKER_CREDS_USR/javafile:$BUILD_NUMBER 
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker tag javafile:$BUILD_NUMBER $DOCKER_CREDS_USR/javafile:latest
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker push $DOCKER_CREDS_USR/javafile:$BUILD_NUMBER
                        ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 docker push $DOCKER_CREDS_USR/javafile:latest
                    '''
                }
            }
        }

        stage('copy manifests file to ansible server'){
            agent any
            steps{
                sshagent(['ssh-ansible']){

                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 cd /home/ubuntu/'
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@34.204.5.44 cd /home/ubuntu/kubernetes/ && ansible-playbook ansible-deploy.yml -i inv'

                }           
            }
        }
    } 
}