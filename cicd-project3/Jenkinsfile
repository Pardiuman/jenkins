pipeline{
    agent any
    stages{
        stage('sonar'){
            agent{
                docker{
                    image 'maven'
                    args '-v $HOME/.m2:/root/.m2 --user=root'
                }
            }
            steps{
                script{
                    withSonarQubeEnv(credentialsId: 'sonar-secret') {
                        sh 'cd cicd-project3 && mvn clean install'
                        sh 'cd cicd-project3 && mvn sonar:sonar'

                    }

                    timeout(time: 1, unit: 'HOURS'){
                        def qualityGate = waitForQualityGates()
                        if(qualityGate != 'OK'){
                            error "quality gate failure ${qualityGate.status}"
                        }
                    }

                   
                }
            }
        }
    }
}